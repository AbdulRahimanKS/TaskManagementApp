{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<style>
    .dataTables_filter {
        margin-bottom: 15px;
    }

    .dataTables_length {
        margin-bottom: 15px;
    }

    .modal .form-label-sm {
        font-size: 0.813rem;
        margin-bottom: 0.25rem;
    }

    .modal .form-control-sm,
    .modal .form-select-sm {
        font-size: 0.813rem;
        padding: 0.375rem 0.5rem;
    }

    .modal .position-relative .toggle-password-add,
    .modal .position-relative .toggle-password-edit {
        font-size: 0.9rem !important;
    }

    .form-select {
        appearance: auto !important;
        -webkit-appearance: auto !important;
        -moz-appearance: auto !important;
        background-image: initial !important;
    }

    .form-select,
    .form-select option {
        color: #212529 !important;
        font-weight: 500;
    }

    .form-select,
    .form-select option {
        color: #212529 !important;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}

<div class="col-12">
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-0">Task Report</h4>
      </div>

      <div class="table-responsive">
        <table id="taskReportTable" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Sl.No</th>
              <th>Task Title</th>
              <th>Assigned User</th>
              <th>Worked Hours</th>
              <th>Completion Report</th>
              <th>Report</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ task.title }}</td>
              <td>{{ task.assigned_to.email }}</td>
              <td>{{ task.worked_hours }} hrs</td>
              <td>{{ task.completion_report|truncatechars:50 }}</td>
              <td>
                <i class="mdi mdi-file-document text-muted ms-3 view-report" 
                    title="View Report" style="cursor:pointer; font-size:1.2rem;"
                    data-task-title="{{ task.title }}"
                    data-task-user="{{ task.assigned_to.email }}"
                    data-completion-report="{{ task.completion_report }}"
                    data-worked-hours="{{ task.worked_hours }}">
                </i>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>


<!-- View Report Modal -->
<div class="modal fade" id="viewReportModal" tabindex="-1" aria-labelledby="viewReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="viewReportModalLabel">
          <i class="mdi mdi-file-document-outline me-2"></i>Task Report
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Task:</strong> <span id="reportTaskTitle"></span></p>
        <p><strong>Assigned To:</strong> <span id="reportTaskUser"></span></p>
        <p><strong>Worked Hours:</strong> <span id="reportWorkedHours"></span> hrs</p>
        <hr>
        <p><strong>Completion Report:</strong></p>
        <p id="reportCompletionText" class="border p-2 rounded bg-muted"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function() {
        $('#taskReportTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "order": [[0, "asc"]],
            "lengthMenu": [5, 10, 25, 50],
            "pageLength": 10,
            "columnDefs": [
                { "searchable": false, "targets": [4, 5] },
                { "orderable": false, "targets": [4, 5] }
            ]
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.view-report').forEach(icon => {
            icon.addEventListener('click', function() {
                document.getElementById('reportTaskTitle').textContent = this.dataset.taskTitle;
                document.getElementById('reportTaskUser').textContent = this.dataset.taskUser;
                document.getElementById('reportWorkedHours').textContent = this.dataset.workedHours;
                document.getElementById('reportCompletionText').textContent = this.dataset.completionReport;

                new bootstrap.Modal(document.getElementById('viewReportModal')).show();
            });
        });
    });
</script>

{% endblock %}
