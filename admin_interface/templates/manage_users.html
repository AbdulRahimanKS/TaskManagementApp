{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<style>
    .dataTables_filter {
        margin-bottom: 15px;
    }

    .dataTables_length {
        margin-bottom: 15px;
    }

    .modal .form-label-sm {
        font-size: 0.813rem;
        margin-bottom: 0.25rem;
    }

    .modal .form-control-sm,
    .modal .form-select-sm {
        font-size: 0.813rem;
        padding: 0.375rem 0.5rem;
    }

    .modal .position-relative .toggle-password-add,
    .modal .position-relative .toggle-password-edit {
        font-size: 0.9rem !important;
    }

    .form-select {
        appearance: auto !important;
        -webkit-appearance: auto !important;
        -moz-appearance: auto !important;
        background-image: initial !important;
    }

    .form-select,
    .form-select option {
        color: #212529 !important;
        font-weight: 500;
    }

    .form-select,
    .form-select option {
        color: #212529 !important;
        font-weight: 500;
    }

</style>
{% endblock %}

{% block content %}
<div class="col-12">
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-0">Manage Users</h4>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal" style="padding: 8px;">
          <i class="mdi mdi-account-plus me-1"></i> Add User
        </button>
      </div>

      <div class="table-responsive">
        <table id="usersTable" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Sl.No</th>
              <th>Full Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Assigned Admin</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in all_users %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ user.title }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.get_role_display }}</td>
              <td>
                {% if user.assigned_admin %}
                    {{ user.assigned_admin.email }}
                {% else %}
                    -
                {% endif %}
              </td>
              <td>
                <i class="mdi mdi-pencil text-muted edit-user" 
                   title="Edit" 
                   style="cursor: pointer; font-size: 1.2rem;"
                   data-bs-toggle="modal" 
                   data-bs-target="#editUserModal"
                   data-user-id="{{ user.id }}"
                   data-user-first_name="{{ user.first_name }}"
                   data-user-last_name="{{ user.last_name }}"
                   data-user-email="{{ user.email }}"
                   data-user-role="{{ user.role }}"
                   data-user-admin="{{ user.assigned_admin.id|default:'' }}"></i>
                <i class="mdi mdi-delete text-danger ms-3 delete-user" 
                   title="Delete" 
                   style="cursor: pointer; font-size: 1.2rem;"
                   data-bs-toggle="modal" 
                   data-bs-target="#deleteUserModal"
                   data-user-id="{{ user.id }}"
                   data-user-name="{{ user.title }}"></i>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-l">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title mb-0" id="addUserModalLabel">
          <i class="mdi mdi-account-plus me-2"></i>Add New User
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addUserForm" method="post" action="{% url 'add_user' %}">
        {% csrf_token %}
        <div class="modal-body py-3">
          <div class="mb-2">
            <label for="addFirstName" class="form-label form-label-sm">First Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm" id="addFirstName" name="first_name" required>
          </div>
          <div class="mb-2">
            <label for="addLastName" class="form-label form-label-sm">Last Name</label>
            <input type="text" class="form-control form-control-sm" id="addLastName" name="last_name">
          </div>
          <div class="mb-2">
            <label for="addUserEmail" class="form-label form-label-sm">Email Address <span class="text-danger">*</span></label>
            <input type="email" class="form-control form-control-sm" id="addUserEmail" name="email" required>
          </div>
          <div class="mb-2">
            <label for="addUserPassword1" class="form-label form-label-sm">Password <span class="text-danger">*</span></label>
            <div class="position-relative">
              <input type="password" class="form-control form-control-sm pe-5" id="addUserPassword1" name="password" required>
              <i class="mdi mdi-eye position-absolute toggle-password-add-1" 
                 style="right:8px; top:13px; cursor:pointer; font-size: 1rem;"></i>
            </div>
          </div>
          <div class="mb-2">
            <label for="addUserPassword2" class="form-label form-label-sm">Confirm Password<span class="text-danger">*</span></label>
            <div class="position-relative">
              <input type="password" class="form-control form-control-sm pe-5" id="addUserPassword2" name="confirm_password" required>
              <i class="mdi mdi-eye position-absolute toggle-password-add-2" 
                 style="right:8px; top:13px; cursor:pointer; font-size: 1rem;"></i>
            </div>
            <small id="passwordError" class="text-danger" style="display:none;">Passwords do not match</small>
          </div>
          <div class="mb-2">
            <label for="addUserRole" class="form-label form-label-sm">Role <span class="text-danger">*</span></label>
            <select class="form-select form-select-sm" id="addUserRole" name="role" required>
            <option value="" disabled selected>--Select Role--</option>
                {% for value, label in choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
          </div>
          <div class="mb-2" id="assignedAdminWrapper" style="display:none;">
            <label for="addAssignAdmin" class="form-label form-label-sm">Assign Admin</label>
            <select class="form-select form-select-sm" id="addAssignAdmin" name="assigned_admin">
                <option value="" disabled selected>--Select Admin--</option>
                {% for admin in admin_users %}
                <option value="{{ admin.id }}">{{ admin.email }}</option>
                {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-info btn-sm" data-bs-dismiss="modal">
            <i class="mdi mdi-close me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-info btn-sm">
            <i class="mdi mdi-check me-1"></i>Add User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-l">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title mb-0" id="editUserModalLabel">
          <i class="mdi mdi-account-edit me-2"></i>Edit User
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editUserForm" method="post" action="{% url 'update_user' %}">
        {% csrf_token %}
        <input type="hidden" name="user_id" id="editUserId">
        <div class="modal-body py-3">
          <div class="mb-2">
            <label for="editFirstName" class="form-label form-label-sm">First Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm" id="editFirstName" name="first_name" required>
          </div>
          <div class="mb-2">
            <label for="editLastName" class="form-label form-label-sm">Last Name</label>
            <input type="text" class="form-control form-control-sm" id="editLastName" name="last_name">
          </div>
          <div class="mb-2">
            <label for="editUserEmail" class="form-label form-label-sm">Email Address <span class="text-danger">*</span></label>
            <input type="email" class="form-control form-control-sm" id="editUserEmail" name="email" required>
          </div>
          <div class="mb-2">
            <label for="editUserRole" class="form-label form-label-sm">Role <span class="text-danger">*</span></label>
            <select class="form-select form-select-sm" id="editUserRole" name="role" required>
              <option value="" disabled>--Select Role--</option>
              {% for value, label in choices %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2" id="editAssignedAdminWrapper" style="display:none;">
            <label for="editAssignedAdmin" class="form-label form-label-sm">Assign Admin</label>
            <select class="form-select form-select-sm" id="editAssignedAdmin" name="assigned_admin">
              <option value="" disabled>--Select Admin--</option>
              {% for admin in admin_users %}
              <option value="{{ admin.id }}">{{ admin.email }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-info btn-sm" data-bs-dismiss="modal">
            <i class="mdi mdi-close me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-info btn-sm">
            <i class="mdi mdi-check me-1"></i>Update User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="deleteUserModalLabel">
          <i class="mdi mdi-alert-circle me-2"></i>Confirm Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'delete_user' %}" id="deleteUserForm">
        {% csrf_token %}
        <input type="hidden" name="user_id" id="deleteUserId">
        <div class="modal-body">
          <div class="text-center py-3">
            <i class="mdi mdi-alert-circle-outline text-danger" style="font-size: 4rem;"></i>
            <h5 class="mt-3">Are you sure you want to delete this user?</h5>
          </div>
        </div>
        <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-info me-2" data-bs-dismiss="modal">
                <i class="mdi mdi-close me-1"></i>Cancel
            </button>
            <button type="submit" class="btn btn-danger">
                <i class="mdi mdi-delete me-1"></i>Delete User
            </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div aria-live="polite" aria-atomic="true" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999; right: 0; top: 0;">
    {% if messages %}
        {% for message in messages %}
        <div class="toast align-items-center text-white 
            {% if 'error' in message.tags %}bg-danger{% elif 'success' in message.tags %}bg-success{% else %}bg-primary{% endif %}" 
            role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function() {
        $('#usersTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "order": [[0, "asc"]],
            "lengthMenu": [5, 10, 25, 50],
            "pageLength": 10,
            "columnDefs": [
                { "searchable": false, "targets": [5] },
                { "orderable": false, "targets": [5] }
            ]
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        var toastElList = [].slice.call(document.querySelectorAll('.toast'));
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl, { delay: 3000 });
        });
        toastList.forEach(toast => toast.show());

        document.querySelector('.toggle-password-add-1').addEventListener('click', function() {
            let input = document.getElementById('addUserPassword1');
            if (input.type === "password") {
                input.type = "text";
                this.classList.replace("mdi-eye", "mdi-eye-off");
            } else {
                input.type = "password";
                this.classList.replace("mdi-eye-off", "mdi-eye");
            }
        });

        document.querySelector('.toggle-password-add-2').addEventListener('click', function() {
            let input = document.getElementById('addUserPassword2');
            if (input.type === "password") {
                input.type = "text";
                this.classList.replace("mdi-eye", "mdi-eye-off");
            } else {
                input.type = "password";
                this.classList.replace("mdi-eye-off", "mdi-eye");
            }
        });

        let roleSelect = document.getElementById('addUserRole');
        let assignedAdminWrapper = document.getElementById('assignedAdminWrapper');

        roleSelect.addEventListener('change', function() {
            if (this.value === 'user') {
                assignedAdminWrapper.style.display = 'block';
            } else {
                assignedAdminWrapper.style.display = 'none';
                document.getElementById('addAssignAdmin').value = "";
            }
        });

        const form = document.getElementById('addUserForm');
        const pwd1 = document.getElementById('addUserPassword1');
        const pwd2 = document.getElementById('addUserPassword2');
        const errorMsg = document.getElementById('passwordError');

        form.addEventListener('submit', function(e) {
            if (pwd1.value !== pwd2.value) {
                e.preventDefault();
                errorMsg.style.display = 'block';
                pwd2.classList.add('is-invalid');
            } else {
                errorMsg.style.display = 'none';
                pwd2.classList.remove('is-invalid');
            }
        });

        pwd2.addEventListener('input', function() {
            if (pwd1.value !== pwd2.value) {
                errorMsg.style.display = 'block';
                pwd2.classList.add('is-invalid');
            } else {
                errorMsg.style.display = 'none';
                pwd2.classList.remove('is-invalid');
            }
        });

        let deleteUserModal = document.getElementById('editUserModal');

        const deleteButtons = document.querySelectorAll('.delete-user');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function () {
                document.getElementById('deleteUserId').value = this.dataset.userId;
                document.getElementById('deleteUserName').textContent = this.dataset.userName;
            });
        });

        let editUserModal = document.getElementById('editUserModal');

        editUserModal.addEventListener('show.bs.modal', function (event) {
            let button = event.relatedTarget;

            let userId = button.getAttribute('data-user-id');
            let firstName = button.getAttribute('data-user-first_name');
            let lastName = button.getAttribute('data-user-last_name');
            let email = button.getAttribute('data-user-email');
            let role = button.getAttribute('data-user-role');
            let assignedAdmin = button.getAttribute('data-user-admin');

            document.getElementById('editUserId').value = userId;
            document.getElementById('editFirstName').value = firstName;
            document.getElementById('editLastName').value = lastName;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = role;

            toggleAssignedAdmin(role, assignedAdmin);
        });

        let editUserRoleSelect = document.getElementById('editUserRole');
        editUserRoleSelect.addEventListener('change', function() {
            toggleAssignedAdmin(this.value);
        });

        function toggleAssignedAdmin(role, assignedAdmin = '') {
            let assignedAdminWrapper = document.getElementById('editAssignedAdminWrapper');
            let assignAdminSelect = document.getElementById('editAssignedAdmin');

            if (role === 'user') {
                assignedAdminWrapper.style.display = 'block';
                assignAdminSelect.value = assignedAdmin || '';
            } else {
                assignedAdminWrapper.style.display = 'none';
                assignAdminSelect.value = '';
            }
        }

    });


</script>

{% endblock %}

