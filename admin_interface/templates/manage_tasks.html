{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<style>
    .dataTables_filter {
        margin-bottom: 15px;
    }

    .dataTables_length {
        margin-bottom: 15px;
    }

    .modal .form-label-sm {
        font-size: 0.813rem;
        margin-bottom: 0.25rem;
    }

    .modal .form-control-sm,
    .modal .form-select-sm {
        font-size: 0.813rem;
        padding: 0.375rem 0.5rem;
    }

    .modal .position-relative .toggle-password-add,
    .modal .position-relative .toggle-password-edit {
        font-size: 0.9rem !important;
    }

    .form-select {
        appearance: auto !important;
        -webkit-appearance: auto !important;
        -moz-appearance: auto !important;
        background-image: initial !important;
    }

    .form-select,
    .form-select option {
        color: #212529 !important;
        font-weight: 500;
    }

    .form-select,
    .form-select option {
        color: #212529 !important;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}

<div class="col-12">
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-0">Manage Tasks</h4>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTaskModal" style="padding: 8px;">
          <i class="mdi mdi-clipboard-plus me-1"></i> Add Task
        </button>
      </div>

      <div class="table-responsive">
        <table id="tasksTable" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Sl.No</th>
              <th>Task Title</th>
              <th>Assigned User</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
            <tr 
                data-task-id="{{ task.id }}"
                data-title="{{ task.title }}"
                data-description="{{ task.description }}"
                data-assigned-to="{{ task.assigned_to.id }}"
                data-due-date="{{ task.due_date|date:'Y-m-d' }}"
                data-status="{{ task.status }}"
                data-completion-report="{{ task.completion_report|default:'' }}"
                data-worked-hours="{{ task.worked_hours|default:'' }}"
            >
              <td>{{ forloop.counter }}</td>
              <td>{{ task.title }}</td>
              <td>{{ task.assigned_to.email }}</td>
              <td>{{ task.due_date }}</td>
              <td>
                {% if task.status == 'pending' %}
                    <span class="badge bg-warning" style="border-radius: 15px;">{{ task.get_status_display }}</span>
                {% elif task.status == 'in_progress' %}
                    <span class="badge bg-info" style="border-radius: 15px;">{{ task.get_status_display }}</span>
                {% elif task.status == 'completed' %}
                    <span class="badge bg-success" style="border-radius: 15px;">{{ task.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-secondary" style="border-radius: 15px;">{{ task.get_status_display }}</span>
                {% endif %}
              </td>
              <td>
                <i class="mdi mdi-pencil text-muted edit-task" 
                   title="Edit" 
                   style="cursor: pointer; font-size: 1.2rem;">
                </i>
                <i class="mdi mdi-delete text-danger ms-3 delete-task" 
                   title="Delete" 
                   style="cursor: pointer; font-size: 1.2rem;"
                   data-task-id="{{ task.id }}">
                </i>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-l">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title mb-0" id="addTaskModalLabel">
          <i class="mdi mdi-clipboard-plus me-2"></i>Add New Task
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addTaskForm" method="post" action="{% url 'add_task' %}">
        {% csrf_token %}
        <div class="modal-body py-3">
          <div class="mb-2">
            <label for="taskTitle" class="form-label form-label-sm">Task Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm" id="taskTitle" name="title" required>
          </div>
          <div class="mb-2">
            <label for="taskDescription" class="form-label form-label-sm">Description <span class="text-danger">*</span></label>
            <textarea class="form-control form-control-sm" id="taskDescription" name="description" rows="3" style="min-height:100px;" required></textarea>
          </div>
          <div class="mb-2">
            <label for="taskAssignedUser" class="form-label form-label-sm">Assign To <span class="text-danger">*</span></label>
            <select class="form-select form-select-sm" id="taskAssignedUser" name="assigned_to" required>
              <option value="" disabled selected>--Select User--</option>
              {% for user in users %}
              <option value="{{ user.id }}">{{ user.email }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label for="taskDueDate" class="form-label form-label-sm">Due Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control form-control-sm" id="taskDueDate" name="due_date" required>
          </div>
          <input type="hidden" name="status" value="pending">
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-info btn-sm" data-bs-dismiss="modal">
            <i class="mdi mdi-close me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-info btn-sm">
            <i class="mdi mdi-check me-1"></i>Add Task
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-l">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title mb-0" id="editTaskModalLabel">
          <i class="mdi mdi-pencil me-2"></i>Edit Task
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editTaskForm" method="post" action="{% url 'update_task' %}">
        {% csrf_token %}
        <input type="hidden" name="task_id" id="editTaskId">
        
        <div class="modal-body py-3">
          <div class="mb-2">
            <label for="editTaskTitle" class="form-label form-label-sm">Task Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm" id="editTaskTitle" name="title" required>
          </div>
          <div class="mb-2">
            <label for="editTaskDescription" class="form-label form-label-sm">Description <span class="text-danger">*</span></label>
            <textarea class="form-control form-control-sm" id="editTaskDescription" name="description" rows="3" style="min-height:100px;" required></textarea>
          </div>
          <div class="mb-2">
            <label for="editTaskAssignedUser" class="form-label form-label-sm">Assign To <span class="text-danger">*</span></label>
            <select class="form-select form-select-sm" id="editTaskAssignedUser" name="assigned_to" required>
              <option value="" disabled>--Select User--</option>
              {% for user in users %}
              <option value="{{ user.id }}">{{ user.email }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label for="editTaskDueDate" class="form-label form-label-sm">Due Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control form-control-sm" id="editTaskDueDate" name="due_date" required>
          </div>
          <div class="mb-2">
            <label for="editTaskStatus" class="form-label form-label-sm">Status <span class="text-danger">*</span></label>
            <select class="form-select form-select-sm" id="editTaskStatus" name="status" required>
              <option value="" disabled>--Select Status--</option>
              {% for value, label in task_status %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2 d-none" id="completionReportWrapper">
            <label for="editCompletionReport" class="form-label form-label-sm">Completion Report</label>
            <textarea class="form-control form-control-sm" id="editCompletionReport" name="completion_report" rows="3" style="min-height:100px;"></textarea>
          </div>
          <div class="mb-2 d-none" id="workedHoursWrapper">
            <label for="editWorkedHours" class="form-label form-label-sm">Worked Hours</label>
            <input type="number" class="form-control form-control-sm" id="editWorkedHours" name="worked_hours" step="0.1" min="0" placeholder="Enter hours worked (e.g. 2.5)">
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-info btn-sm" data-bs-dismiss="modal">
            <i class="mdi mdi-close me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-info btn-sm">
            <i class="mdi mdi-check me-1"></i>Update Task
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="deleteTaskModalLabel">
          <i class="mdi mdi-alert-circle me-2"></i>Confirm Task Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'delete_task' %}" id="deleteTaskForm">
        {% csrf_token %}
        <input type="hidden" name="task_id" id="deleteTaskId">
        <div class="modal-body">
          <div class="text-center py-3">
            <i class="mdi mdi-alert-circle-outline text-danger" style="font-size: 4rem;"></i>
            <h5 class="mt-3">Are you sure you want to delete this task?</h5>
          </div>
        </div>
        <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-info me-2" data-bs-dismiss="modal">
                <i class="mdi mdi-close me-1"></i>Cancel
            </button>
            <button type="submit" class="btn btn-danger">
                <i class="mdi mdi-delete me-1"></i>Delete Task
            </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div aria-live="polite" aria-atomic="true" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999; right: 0; top: 0;">
    {% if messages %}
        {% for message in messages %}
        <div class="toast align-items-center text-white 
            {% if 'error' in message.tags %}bg-danger{% elif 'success' in message.tags %}bg-success{% else %}bg-primary{% endif %}" 
            role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function() {
        $('#tasksTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "order": [[0, "asc"]],
            "lengthMenu": [5, 10, 25, 50],
            "pageLength": 10,
            "columnDefs": [
                { "searchable": false, "targets": [5] },
                { "orderable": false, "targets": [5] }
            ]
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        var toastElList = [].slice.call(document.querySelectorAll('.toast'));
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl, { delay: 3000 });
        });
        toastList.forEach(toast => toast.show());

        document.querySelectorAll('.edit-task').forEach(icon => {
            icon.addEventListener('click', function() {
                const row = this.closest('tr');

                const taskId = row.dataset.taskId;
                const title = row.dataset.title;
                const description = row.dataset.description;
                const assignedTo = row.dataset.assignedTo;
                const dueDate = row.dataset.dueDate;
                const status = row.dataset.status;
                const completionReport = row.dataset.completionReport;
                const workedHours = row.dataset.workedHours;

                document.getElementById('editTaskId').value = taskId;
                document.getElementById('editTaskTitle').value = title;
                document.getElementById('editTaskDescription').value = description;
                document.getElementById('editTaskAssignedUser').value = assignedTo;
                document.getElementById('editTaskDueDate').value = dueDate;
                document.getElementById('editTaskStatus').value = status;

                if (status === 'completed') {
                    document.getElementById('completionReportWrapper').classList.remove('d-none');
                    document.getElementById('workedHoursWrapper').classList.remove('d-none');
                    document.getElementById('editCompletionReport').value = completionReport;
                    document.getElementById('editWorkedHours').value = workedHours;
                } else {
                    document.getElementById('completionReportWrapper').classList.add('d-none');
                    document.getElementById('workedHoursWrapper').classList.add('d-none');
                    document.getElementById('editCompletionReport').value = '';
                    document.getElementById('editWorkedHours').value = '';
                }

                new bootstrap.Modal(document.getElementById('editTaskModal')).show();
            });
        });

        document.getElementById('editTaskStatus').addEventListener('change', function() {
            if (this.value === 'completed') {
                document.getElementById('completionReportWrapper').classList.remove('d-none');
                document.getElementById('workedHoursWrapper').classList.remove('d-none');
            } else {
                document.getElementById('completionReportWrapper').classList.add('d-none');
                document.getElementById('workedHoursWrapper').classList.add('d-none');
            }
        });

        document.querySelectorAll('.delete-task').forEach(icon => {
            icon.addEventListener('click', function() {
                const taskId = this.dataset.taskId;
                document.getElementById('deleteTaskId').value = taskId;

                new bootstrap.Modal(document.getElementById('deleteTaskModal')).show();
            });
        });

    });
</script>

{% endblock %}
